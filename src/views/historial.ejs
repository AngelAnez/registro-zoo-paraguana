<%- include('partials/head', {title : "Historial", css : "", js : "historial.js", header: true}); %>
<body class="d-flex bg-body-secondary">
  <!-- Menu Lateral y Main-->
  <%- include('partials/sidebar'); %>
  <main class="container-fluid row d-flex flex-column p-0 m-0 gap-3 vh-100 w-100">
    <!-- Encabezado -->
    <%- include('partials/header'); %>

    <nav class="navbar m-0 user-select-none">
      <section class="container-fluid">
        <form class="d-flex w-100 align-items-center justify-content-center gap-4" role="search">
          <section class="col-8 bg-light-subtle rounded-4 shadow py-2 d-flex justify-content-evenly align-items-center">
            <h6 class="m-0"> Buscar Visita: </h6>
            <section class="col-8">
              <input class="form-control" type="search" aria-label="Search" name="filter" value="<%=searchFilter%>" autocomplete="off" title="Ingrese una palabra clave para realizar una búsqueda"/>
            </section>
            
          </section>
          
          <button class="btn btn-success shadow" type="submit" title="Filtra las visitas según la palabra clave ingresada">Buscar</button>
          <a class="btn btn-primary shadow" href="/historial" title="Elimina los filtros y muestra todas las visitas">Limpiar</a>
        </form>
      </section>
    </nav>

    <section class="container py-2 px-4 table-responsive">
      <table class="table text-center table-hover table-sm table-rounded rounded-2 overflow-hidden shadow border">
        <thead class="table-success">
          <tr class="user-select-none">
            <% if (searchFilter != "") { %> 
              <% searchFilter = "&filter=" + searchFilter %> 
            <% } %> 
            <% if (sort == "date" && order == "asc"){ %>
            <th scope="col">
              <a href="/historial?pag=<%=pag%>&sort=date&order=dec<%=searchFilter%>" class="text-decoration-none text-black" data-bs-toggle="tooltip" data-bs-placement="top" data-bs-title="Fecha de cada Visita (Orden Ascendente)">Fecha &uarr;</a>
            </th>
            <% } else if (sort == "date" && order == "dec"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=date&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Fecha de cada Visita (Orden Descendente)"
                >Fecha &darr;</a
              >
            </th>
            <% } else { %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=date&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Fecha de cada Visita"
                >Fecha</a
              >
            </th>
            <% } %> 
            <% if (sort == "time" && order == "asc"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=time&order=dec<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Hora de Llegada de cada Visita (Orden Ascendente)"
                >Hora &uarr;
              </a>
            </th>
            <% } else if (sort == "time" && order == "dec"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=time&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Hora de Llegada de cada Visita (Orden Descendente)"
                >Hora &darr;</a
              >
            </th>
            <% } else { %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=time&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Hora de Llegada de cada Visita"
                >Hora</a
              >
            </th>
            <% } %>
            <% if (sort == "childrenNumber" && order == "asc"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=childrenNumber&order=dec<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Niños por Visita (Orden Ascendente)"
                >Niños &uarr;</a
              >
            </th>
            <% } else if (sort == "childrenNumber" && order == "dec"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=childrenNumber&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Niños por Visita (Orden Descendente)"
                >Niños &darr;</a
              >
            </th>
            <% } else { %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=childrenNumber&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Niños por Visita"
                >Niños</a
              >
            </th>
            <% } %>
            <% if (sort == "adultsNumber" && order == "asc"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=adultsNumber&order=dec<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Adultos por Visita (Orden Ascendente)"
                >Adultos &uarr;</a
              >
            </th>
            <% } else if (sort == "adultsNumber" && order == "dec"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=adultsNumber&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Adultos por Visita (Orden Descendente)"
                >Adultos &darr;</a
              >
            </th>
            <% } else { %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=adultsNumber&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Adultos por Visita"
                >Adultos</a
              >
            </th>
            <% } %>
            <% if (sort == "seniorsNumber" && order == "asc"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=seniorsNumber&order=dec<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Adultos Mayores por Visita (Orden Ascendente)"
                >Adultos M. &uarr;</a
              >
            </th>
            <% } else if (sort == "seniorsNumber" && order == "dec"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=seniorsNumber&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Adultos Mayores por Visita (Orden Descendente)"
                >Adultos M. &darr;</a
              >
            </th>
            <% } else { %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=seniorsNumber&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Cantidad de Adultos Mayores por Visita"
                >Adultos M.</a
              >
            </th>
            <% } %>
            <% if (sort == "paymentMethod" && order == "asc"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=paymentMethod&order=dec<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Método de Pago Utilizado (Orden Ascendente)"
                >Método de Pago &uarr;</a
              >
            </th>
            <% } else if (sort == "paymentMethod" && order == "dec"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=paymentMethod&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Método de Pago Utilizado (Orden Descendente)"
                >Método de Pago &darr;</a
              >
            </th>
            <% } else { %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=paymentMethod&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Método de Pago Utilizado"
                >Método de Pago</a
              >
            </th>
            <% } %>
            <% if (sort == "totalBolivars" && order == "asc"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=totalBolivars&order=dec<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Monto Total en Bolivares (Orden Ascendente)"
                >Monto (Bs.) &uarr;</a
              >
            </th>
            <% } else if (sort == "totalBolivars" && order == "dec"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=totalBolivars&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Monto Total en Bolivares (Orden Descendente)"
                >Monto (Bs.) &darr;</a
              >
            </th>
            <% } else { %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=totalBolivars&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Monto Total en Bolivares"
                >Monto (Bs.)</a
              >
            </th>
            <% } %>
            <% if (sort == "totalDolars" && order == "asc"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=totalDolars&order=dec<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Monto Total en Dólares (Orden Ascendente)"
                >Monto ($) &uarr;</a
              >
            </th>
            <% } else if (sort == "totalDolars" && order == "dec"){ %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=totalDolars&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Monto Total en Dólares (Orden Descendente)"
                >Monto ($) &darr;</a
              >
            </th>
            <% } else { %>
            <th scope="col">
              <a
                href="/historial?pag=<%=pag%>&sort=totalDolars&order=asc<%=searchFilter%>"
                class="text-decoration-none text-black"
                data-bs-toggle="tooltip"
                data-bs-placement="top"
                data-bs-title="Monto Total en Dólares"
                >Monto ($)</a
              >
            </th>
            <% } %>
          </tr>
        </thead>
        <tbody>
          <% visits.forEach((visit) => { %>
          <tr
            class="user-select-none"
            style="cursor: pointer"
            title="Pulse aquí para ver más información de la visita"
            data-bs-toggle="modal"
            data-bs-target="#visitInfoModal"
            data-bs-date="<%= visit.date %>"
            data-bs-time="<%= visit.time %>"
            data-bs-childrenNumber="<%= visit.childrenNumber %>"
            data-bs-adultsNumber="<%= visit.adultsNumber %>"
            data-bs-seniorsNumber="<%= visit.seniorsNumber %>"
            data-bs-paymentMethod="<%= visit.paymentMethod %>"
            data-bs-totalBolivars="<%= visit.totalBolivars %>"
            data-bs-totalDolars="<%= visit.totalDolars %>"
            data-bs-extraInfoPayment="<%= visit.extraInfoPayment %>"
            data-bs-representativeName="<%= visit.representativeName %>"
            data-bs-representativePhone="<%= visit.representativePhone%>"
          >
            <td><%= visit.date %></td>
            <td><%= visit.time %></td>
            <td><%= visit.childrenNumber %></td>
            <td><%= visit.adultsNumber %></td>
            <td><%= visit.seniorsNumber %></td>
            <td><%= visit.paymentMethod %></td>
            <td><%= visit.totalBolivars %></td>
            <td><%= visit.totalDolars %></td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </section>

    <% if (pag == 1){ %>
      <% prevPag = 1 %> 
    <% } else { %> 
      <% prevPag = pag-1 %>
    <% } %>
    <% if (sort != "" && order != "") { %>
       <% sortQueries = "&sort=" + sort + "&order=" + order %>
    <% } else { %> 
    <% sortQueries = "" %> 
    <% } %>
    <ul class="pagination d-flex justify-content-center">
      <li class="page-item">
        <a
          class="page-link"
          href="/historial?pag=<%=prevPag%><%=sortQueries%><%=searchFilter%>"
          aria-label="Previous"
        >
          <span aria-hidden="true" class="text-success fw-bold user-select-none"
            >&laquo;</span
          >
        </a>
      </li>

      <% for (let p = 1, stop = false; stop != true; p++) { %> 
        <% if (total > 0){ %>
          <li class="page-item">
            <a
              class="page-link user-select-none <% if (pag == p) { %> text-bg-success <% } else { %> text-success <% } %> fw-bold"
              href="/historial?pag=<%=p%><%=sortQueries%><%=searchFilter%>"
              ><%= p %>
            </a>
          </li>
          <% total -= 10 %>
        <% } else {%>
          <% nextPage = p-1%>
          <% stop = true %>
        <% } %>
      <% } %>
      <% if (pag != nextPage){ %>
        <% nextPage = pag + 1 %> 
      <% } %>

      <li class="page-item">
        <a
          class="page-link"
          href="/historial?pag=<%=nextPage%><%=sortQueries%><%=searchFilter%>"
          aria-label="Next"
        >
          <span aria-hidden="true" class="text-success fw-bold user-select-none"
            >&raquo;</span
          >
        </a>
      </li>
    </ul>

    <!-- Modal de cada visitante  -->
    <article class="modal fade" id="visitInfoModal" tabindex="-1" aria-hidden="true">
      <section class="modal-dialog modal-dialog-centered">
          <section class="modal-content">
              <header class="modal-header text-bg-success user-select-none">
                  <h1 class="modal-title fs-5">Información de la Visita</h1>
                  <button class="btn text-light p-0 opacityHover" data-bs-dismiss="modal" aria-label="Close">
                      <i data-lucide="x" alt="close-icon"></i>
                  </button>
              </header>
              <section class="modal-body d-flex flex-column py-2 px-3">
                <section class="d-flex px-2 user-select-none">
                  <section class="col-9">
                    <label for="representativeNameVisitValue">Representante:</label>
                    <h6 id="representativeNameVisitValue">Angel Añez</h6>
                    <label for="representativePhoneVisitValue">Número de Contacto:</label>
                    <h6 id="representativePhoneVisitValue">04162135164</h6>
                  </section>
                  <section class="col-3">
                    <label for="dateVisitValue">Fecha:</label>
                    <h6 id="dateVisitValue">Angel Añez</h6>
                    <label for="timeVisitValue">Hora:</label>
                    <h6 id="timeVisitValue">04162135164</h6>
                  </section>
                </section>
                <hr class="p-0 my-2">
                <section class="container-fluid d-flex justify-content-around user-select-none">
                  <section class="m-0 p-0 d-flex flex-column justify-content-start col-3">
                    <img class="p-3" src="./public/assets/img/children.webp" alt="childrenImg">
                    <h3 class="text-center" id="childrenNumberVisitValue"></h3>
                    <p class="text-center">Niños</p>
                  </section>
                  <section class="m-0 p-0 d-flex flex-column justify-content-start col-3">
                    <img class="p-3" src="./public/assets/img/adults.webp" alt="adultsImg">
                    <h3 class="text-center" id="adultsNumberVisitValue"></h3>
                    <p class="text-center">Adultos</p>
                  </section>
                  <section class="m-0 p-0 d-flex flex-column justify-content-start col-3">
                    <img class="p-3" src="./public/assets/img/seniors.webp" alt="seniorsImg">
                    <h3 class="text-center" id="seniorsNumberVisitValue"></h3>
                    <p class="text-center">Adultos Mayores</p>
                  </section>
                </section>
              </section>
              <footer class="modal-footer container-fluid p-0 d-flex align-items-start m-0 user-select-none">
                <div class="row p-0 m-0 w-100">
                  <section class="col-8 d-flex flex-column m-0 py-2 px-3 text-justify text-bg-secondary gap-2" style="border-bottom-left-radius: 0.375rem;">
                    <p class="m-0 fw-bold">Método de Pago: <span id="paymentMethodVisitValue" class="fw-normal"></span></p>
                    <p class="m-0 fw-bold"><span id="extraInfoType"></span> <span id="extraInfoPaymentVisitValue" class="fw-normal"></span></p>
                  </section>
                  <section class="col-4 d-flex flex-column text-bg-success m-0 py-2 px-3 rounded-bottom-2 rounded-start-0">
                    <section class="d-flex flex-column gap-1">
                      <p class="text-start w-100 m-0 fw-bold">Total:</p>
                      <h5 class="text-end w-100 m-0"><span id="totalBolivarsVisitValue"></span> Bs.</h5>
                      <h5 class="text-end w-100 m-0"><span id="totalDolarsVisitValue"></span> $</h6>
                    </section>
                  </section>
                </div>
              </footer>
          </section>
      </section>
  </article>

  </main>
  <%- include('partials/scripts')%>
<%- include('partials/foot'); %>